<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
    // var socket = io.connect('http://' + document.domain + ':' + location.port);
    var socket = io.connect('http://127.0.0.1:5000');
    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
    });
    </script>

    <title>player {{ game_state['player'] }} game1</title>
</head> 
<svg id=g width="500" height="100" style='background-color: grey;'>
</svg>

<h1>player {{ game_state['player'] }} game1</h1>

<script>
    var xmlns = "http://www.w3.org/2000/svg";

    var svgWidth = 1000

    var Cols = ['a', 'b', 'c', 'd','e','f','g','h','i','j','k']
    var Rows = [1, 2, 3, 4, 5]
    var nbHexAcross = Cols.length
    var hexWidth = svgWidth/(nbHexAcross)
    var hexHeight = Math.sqrt(2)*hexWidth - hexWidth
    var hexSideLength = Math.sqrt(2)*hexWidth
    var svgHeight = (Rows.length+1)*hexHeight

    var points = [] // holds the location & state of each point
    var game_state = {{ game_state | tojson}}

    function point (name, x, y) {
        this.name = name;
        this.x = x;
        this.y = y;
        this.state = "blank"
    }

    function resizeSvg(width, height) {
        g.setAttribute("width", width);
        g.setAttribute("height", height);
    }

    function drawPoint(name, x, y, radius) {
        drawPoint.count = ++drawPoint.count || 1
        var newPoint = document.createElementNS(xmlns, "circle");
        newPoint.setAttributeNS(null,"id", name);
        newPoint.setAttributeNS(null,"cx",x);
        newPoint.setAttributeNS(null,"cy",y);
        newPoint.setAttributeNS(null,"r",radius);
        newPoint.setAttributeNS(null,"fill", "blue");
        newPoint.setAttributeNS(null,"onclick", "changeState(\"" + name + "\")")
        g.appendChild(newPoint);
    };

    function changeState(pointName) {
        thisPoint = points[pointName];
        console.log(pointName)
        // can't use $.post() to send JSON data - need access to contentType:
        $.ajax({
            type: 'POST',
            url: "http://127.0.0.1:5000/new_move/"+game_state["player"]+"/"+pointName+"/",
            data: JSON.stringify(game_state),
            // success: function(data) {console.log("POST successful"); updateBoard(data['game_state']);},
            success: function(data) {console.log("POST successful"); console.log(data)},
            contentType: "application/json",
            dataType: 'json'
        });
        console.log(pointName + " POST sent")
    }

    function updatePoint(pointName) {
        pt = $("#"+pointName)[0]
        thisPoint = points[pointName]
        switch (thisPoint.state) {
            case "blank":
            pt.setAttribute("fill","red")
            break;
            case "A":
            pt.setAttribute("fill","green")
            break;
            case "B":
            pt.setAttribute("fill","orange")
            break;
            case "default":
            pt.setAttribute("fill","white")
            break;
        }
    }

    function updateBoard(new_game_state) {
        console.log(new_game_state)
        for (var i in points) {
            if (points.hasOwnProperty(i)) {
                points[i].state = new_game_state[points[i].name]
                updatePoint(points[i].name);
            }
        }
    }

    function generateGrid() {
        for (var rowIdx = Rows.length - 1; rowIdx >= 0; rowIdx--) {
            var yOffset = 1;
            xOffset = rowIdx*0.5-0.5;
            for (var colIdx = Cols.length - 1; colIdx >= 0; colIdx--) {
                name = Cols[colIdx]+Rows[rowIdx];
                if (["a1", "a2", "b1", "j5", "k4", "k5"].indexOf(name) >= 0) {
                    // don't generate points where they don't exist on the board
                    continue
                }
                x = (colIdx+xOffset)*hexWidth
                y = (rowIdx+yOffset)*hexHeight
                drawPoint(name, x, y, 10);
                points[name] = new point(name, x, y)
            }
        }
    };

    socket.on('update_board', function(data){
        console.log("update_board");
        updateBoard(data);
    });


    $(function() {
        resizeSvg(svgWidth, svgHeight);
        generateGrid();
        updateBoard(game_state);
    });
</script>
</html>