<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
    // var socket = io.connect('http://' + document.domain + ':' + location.port);
    var socket = io.connect('http://127.0.0.1:5000');
    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
    });
    </script>

    <title>player {{ player }} game1</title>
</head> 
<svg id=g width="500" height="100" style='background-color: grey;'>
</svg>

<h1>player {{ player }} game1</h1>
    <p>
    <a href="http://127.0.0.1:5000/reset/"> reset </a>

<script>
    var xmlns = "http://www.w3.org/2000/svg";

    var svgWidth = 1000
    var player = '{{ player }}'
    var Cols = ['a', 'b', 'c', 'd','e','f','g','h','i','j','k']
    var Rows = [1, 2, 3, 4, 5]
    var nbHexAcross = Cols.length
    var hexWidth = svgWidth/(nbHexAcross)
    var hexHeight = Math.sqrt(2)*hexWidth - hexWidth
    var hexSideLength = Math.sqrt(2)*hexWidth
    var svgHeight = (Rows.length+1)*hexHeight
    var tile_diameter = 10
    var tile_offset = tile_diameter/3

    var points = [] // holds the location & state of each point
    var highlights = [] // holds the location & state of each point
    var tiles = [] // holds the location & state of each point
    var game_state = {{ game_state | tojson}}

    function point (name, x, y) {
        this.name = name;
        this.x = x;
        this.y = y;
        this.state = [];
        this.highlight = false;
    }

    function resizeSvg(width, height) {
        g.setAttribute("width", width);
        g.setAttribute("height", height);
    }

    function drawPoint(name, x, y, radius) {
        drawPoint.count = ++drawPoint.count || 1
        var newPoint = document.createElementNS(xmlns, "circle");
        newPoint.setAttributeNS(null,"id", name);
        newPoint.setAttributeNS(null,"cx",x);
        newPoint.setAttributeNS(null,"cy",y);
        newPoint.setAttributeNS(null,"r",radius);
        newPoint.setAttributeNS(null,"fill", "blue");
        newPoint.setAttributeNS(null,"onclick", "changeState(\"" + name + "\")")
        g.appendChild(newPoint);
    };

    function drawTile(name, x, y, radius, color) {
        drawTile.count = ++drawTile.count || 1
        var newPoint = document.createElementNS(xmlns, "circle");
        newPoint.setAttributeNS(null,"id", "tile_" + drawTile.count);
        newPoint.setAttributeNS(null,"cx",x);
        newPoint.setAttributeNS(null,"cy",y);
        newPoint.setAttributeNS(null,"r",radius);
        newPoint.setAttributeNS(null,"fill", color);
        newPoint.setAttributeNS(null,"stroke", "black");
        newPoint.setAttributeNS(null,"onclick", "changeState(\"" + name + "\")")
        g.appendChild(newPoint);
        tiles.push(newPoint)
    };

    function removeTiles(tiles_to_remove) {
        for (var i in tiles_to_remove) {
            tiles_to_remove[i].remove()
        }
    }

    function changeState(pointName) {
        thisPoint = points[pointName];
        // can't use $.post() to send JSON data - need access to contentType:
        $.ajax({
            type: 'POST',
            url: "http://127.0.0.1:5000/new_click/"+ player +"/"+pointName+"/",
            data: JSON.stringify(game_state),
            success: function(data) {console.log("POST successful"); console.log(data)},
            contentType: "application/json",
            dataType: 'json'
        });
    }

    function updatePoint(pointName) {
        pt = $("#"+pointName)[0]
        h = $("#h_"+pointName)[0]

        thisPoint = points[pointName]
        thisHighlight = highlights[pointName]
        pt.setAttribute("fill","white")
        for (var i in thisPoint.state) {
            if (thisPoint.state[i] == "A") {
                var color = "green"
            } else {
                var color = "orange"
            }
            drawTile(pointName, thisPoint.x + i*tile_offset, thisPoint.y, tile_diameter, color);
        }

        if (thisPoint.highlight) {
            h.setAttribute("fill", "yellow")
        } else {
            h.setAttribute("fill", "grey")
        }
    }

    function updateBoard(new_game_state) {
        removeTiles(tiles);
        for (var i in points) {
            if (points.hasOwnProperty(i)) {
                points[i].state = new_game_state[points[i].name]
                if (new_game_state["selected"] == i) {
                    points[i].highlight = true;
                } else {
                    points[i].highlight = false;
                }
                updatePoint(points[i].name);
            }
        }
    }

    function generateGrid() {
        for (var rowIdx = Rows.length - 1; rowIdx >= 0; rowIdx--) {
            var yOffset = 1;
            xOffset = rowIdx*0.5-0.5;
            for (var colIdx = Cols.length - 1; colIdx >= 0; colIdx--) {
                name = Cols[colIdx]+Rows[rowIdx];
                if (["a1", "a2", "b1", "j5", "k4", "k5"].indexOf(name) >= 0) {
                    // don't generate points where they don't exist on the board
                    continue
                }
                x = (colIdx+xOffset)*hexWidth
                y = (rowIdx+yOffset)*hexHeight
                drawPoint("h_" + name, x, y, 20);
                highlights[name] = new point("h_"+name, x, y)
                drawPoint(name, x, y, 10);
                points[name] = new point(name, x, y)
            }
        }
    };

    socket.on('update_board', function(data){
        game_state = data;
        console.log("update_board");
        updateBoard(data);
    });

    $(function() {
        resizeSvg(svgWidth, svgHeight);
        generateGrid();
        updateBoard(game_state);
    });
</script>
</html>